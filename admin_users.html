{% extends "base.html" %}

{% block title %}Painel Admin - Gestão de Utilizadores{% endblock %}

{% block content %}
  <h1 class="glow">⚙️ Painel de Administração</h1>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="mt-5">
    <h2>Gestão de Utilizadores</h2>
    <p class="text-muted">Altere as permissões e o cargo dos utilizadores clicando no botão <strong>Editar</strong>.</p>
    
    {% if users %}
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead>
            <tr>
              <th>Utilizador</th>
              <th>Admin</th>
              <th>Scanner</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr>
                <td>
                  <strong>{{ user.username }}</strong>
                  {% if user.id == current_user.id %}
                    <span class="badge bg-success">Você</span>
                  {% endif %}
                </td>
                <td>
                  {% if user.is_admin %}
                    <span class="badge bg-danger">✓ Admin</span>
                  {% else %}
                    <span class="badge bg-secondary">Não</span>
                  {% endif %}
                </td>
                <td>
                  {% if user.is_scanner %}
                    <span class="badge bg-warning text-dark">✓ Sim</span>
                  {% else %}
                    <span class="badge bg-secondary">Não</span>
                  {% endif %}
                </td>
                <td>
                  <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editModal{{ user.id }}">
                    Editar
                  </button>
                </td>
              </tr>

              <!-- Modal para editar permissões -->
              <div class="modal fade" id="editModal{{ user.id }}" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content bg-dark">
                    <div class="modal-header">
                      <h5 class="modal-title">Editar Permissões - {{ user.username }}</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{{ url_for('admin_edit_user_role', user_id=user.id) }}">
                      <div class="modal-body">
                        <div class="form-check mb-3">
                          <input type="checkbox" class="form-check-input" id="admin{{ user.id }}" name="is_admin" {% if user.is_admin %}checked{% endif %}>
                          <label class="form-check-label" for="admin{{ user.id }}">
                            <strong>Administrador</strong>
                            <small class="d-block text-muted">Acesso completo ao painel, pode editar/deletar mangás</small>
                          </label>
                        </div>
                        
                        <div class="form-check mb-3">
                          <input type="checkbox" class="form-check-input" id="scanner{{ user.id }}" name="is_scanner" {% if user.is_scanner %}checked{% endif %}>
                          <label class="form-check-label" for="scanner{{ user.id }}">
                            <strong>Scanner</strong>
                            <small class="d-block text-muted">Pode apenas postar mangás com imagens</small>
                          </label>
                        </div>

                        {% if user.id == current_user.id %}
                          <div class="alert alert-warning" role="alert">
                            ⚠️ <strong>Aviso:</strong> Você é o utilizador autenticado. Não é possível remover suas permissões de administrador.
                          </div>
                        {% endif %}
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Nenhum utilizador registado.</div>
    {% endif %}
  </div>

  <div class="mt-5">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">← Voltar ao Início</a>
  </div>
{% endblock %}
